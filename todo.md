###今回の修正内容

今回の修正で対象となるエントリポイントはsd-scripts\train\run.batです
これを実行するのに呼び出されないものは今回は対象外です

run.batの中でsdxl_train_network.pyで学習を行い、設定ファイルtrain\config.toml train\dataset.tomlを使い学習します
dataset.tomlの中のimage_dir = 'C:\Users\Owner\Documents\python\sd-scripts\train\img'が学習対象の画像およびタグファイルになります
画像は*_neg.webpと*_pos.webpの二つのタイプが存在ます。

これらのファイルを用いて学習する際、*_pos.webpは通常の学習を行い、*_neg.webpはマイナスの方向に学習を行うように修正します

学習の順番は*の部分が同一の*_neg.webpの画像、*_neg.webpの画像、次の*の部分の画像となります

つまり、このような順番で学習します
8d4bf3a967f15dde13348051365016709168_pos.webp
8d4bf3a967f15dde13348051365016709168_neg.webp
26fd905845e82b8f09814934906896276162_pos.webp
26fd905845e82b8f09814934906896276162_neg.webp
72b24bd5557f521012347951177030584715_pos.webp
72b24bd5557f521012347951177030584715_neg.webp

画像の学習順番をシャッフルする場合、同一のposとnegの順番が崩れないようにシャッフルします

26fd905845e82b8f09814934906896276162_pos.webp
26fd905845e82b8f09814934906896276162_neg.webp
72b24bd5557f521012347951177030584715_pos.webp
72b24bd5557f521012347951177030584715_neg.webp
8d4bf3a967f15dde13348051365016709168_pos.webp
8d4bf3a967f15dde13348051365016709168_neg.webp
となります

negもposもついてない画像ファイルが存在する場合、通常の学習として対処します

この修正についての見通しをまず立てて、作業順番をtodo.mdに追記してください


### 提示された修正案に対する要望
画像読み込みは現状ではwebpのみを取り扱ってますが、将来的に他の拡張子の画像ファイルが入り込む可能性があります。現状の実装でpngやjpeg等も読み込み可能なはずですので、それらを維持してください
つまりドキュメントでwebpのみを例に取るのは構いませんが、webpだけを走査する実装ではダメです。
これを踏まえて作業手順の見通しをアップデートしてください


### 作業手順の見通し

1.  **`sdxl_train_network.py` の画像読み込み処理の修正:**
    *   [ ] `dataset.toml` から `image_dir` を取得する処理を確認・実装します。
    *   [ ] `image_dir` 内のサポートされている画像ファイル (例: `.webp`, `.png`, `.jpg`, `.jpeg` など) を走査し、ファイル名と拡張子に基づいて以下の3種類に分類する機能を実装します。
        *   `*_pos.<ext>` (例: `basename_pos.webp`, `basename_pos.png`)
        *   `*_neg.<ext>` (例: `basename_neg.webp`, `basename_neg.jpg`)
        *   上記以外の画像ファイル (通常画像) (例: `basename.jpeg`)
    *   [ ] 画像をベース名 (拡張子および `_pos`/`_neg` サフィックスを除いた部分) でグループ化し、`_pos.<ext1>` と `_neg.<ext2>` のペアを形成します (同一ベース名であれば拡張子が異なっていてもペアとみなすか、同一拡張子のみをペアとするか仕様を明確にする。ここでは同一ベース名であればペアとして扱う方針で進める)。ペアにならない `_pos.<ext>`、`_neg.<ext>`、通常画像も個別に管理します。

2.  **`sdxl_train_network.py` の学習データ準備処理の修正:**
    *   [ ] 学習対象となる画像のリストを生成する処理を修正します。
    *   [ ] 学習順序のルールを適用します:
        *   ペアの場合: `*_pos.<ext>` の次に、対応する `*_neg.<ext>` を学習データとします。
        *   ペアでない `*_pos.<ext>` および通常画像は、そのまま学習データとします。
        *   ペアでない `*_neg.<ext>` は、マイナス学習の対象として扱います。
    *   [ ] シャッフル機能の修正:
        *   シャッフルが有効な場合、画像ペア (または単独画像) の単位でシャッフルを行います。ペア内の `_pos` -> `_neg` の順序は維持します。

3.  **`sdxl_train_network.py` の学習ループの修正:**
    *   [ ] 現在処理中の画像が `*_neg.<ext>` かどうかを判定するロジックを追加します。
    *   [ ] `*_neg.<ext>` の場合、マイナス方向に学習を行う処理を実装します。
        *   具体的なマイナス学習の方法を調査・決定します (例: 損失関数の符号反転、勾配の反転など)。
        *   既存の学習処理への影響を最小限に抑えるように実装します。
    *   [ ] `*_pos.<ext>` および通常画像の場合は、既存の通常学習処理を実行します。

4.  **設定ファイルの検討:**
    *   [ ] `config.toml` または `dataset.toml` に、マイナス学習の挙動を制御するための新しいパラメータ (例: マイナス学習の重み、有効/無効フラグなど) が必要かどうか検討します。現時点では不要と仮定し、コード内で挙動を制御する方針で進めます。
    *   [ ] サポートする画像拡張子を `dataset.toml` などで指定できるようにするか検討します。当面は一般的な画像拡張子 (例: `.webp`, `.png`, `.jpg`, `.jpeg`) をハードコードまたは既存のライブラリの挙動に依存する形で対応します。

5.  **`train\run.bat` の確認:**
    *   [ ] `sdxl_train_network.py` の呼び出し方に変更がないか確認します。
    *   [ ] 必要に応じて、引数の追加や修正を行います。

6.  **テスト:**
    *   [ ] 少数のサンプル画像 (pos/negペア、posのみ、negのみ、通常画像) を、複数の拡張子 (例: `.webp`, `.png`) を混ぜて用意します。
    *   [ ] 学習順序が意図通りであることを確認します (ログ出力などで)。
    *   [ ] シャッフル時にペアが維持されることを確認します。
    *   [ ] `*_neg.<ext>` の学習時に、マイナス学習が実行されていることを確認します (デバッグ情報や、可能であれば学習結果の傾向で)。
    *   [ ] 通常の画像、`*_pos.<ext>` が正しく通常学習されることを確認します。
    *   [ ] 異なる拡張子の画像が正しく読み込まれ、処理されることを確認します。

7.  **ドキュメント更新 (任意):**
    *   [ ] README やコードコメントなどに、新しい画像命名規則 (拡張子を含む)、サポートする画像形式、および学習挙動について追記します。
